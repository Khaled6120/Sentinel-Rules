name: DSInternals Suspicious PowerShell Cmdlets
id: 43d91656-a9b2-4541-b7e2-6a9bd3a13f4e
author: Nasreddine Bencherchali (Nextron Systems), Nounou Mbeiri
date: 2024/06/26
severity: high
description: 'Detects execution and usage of the DSInternals PowerShell module. Which
  can be used to perform what might be considered as suspicious activity such as dumping
  DPAPI backup keys or manipulating NTDS.DIT files.

  The DSInternals PowerShell Module exposes several internal features of Active Directory
  and Azure Active Directory. These include FIDO2 and NGC key auditing, offline ntds.dit
  file manipulation, password auditing, DC recovery from IFM backups and password
  hash calculation.

  '
status: experimental
modified: ''
logsource:
  category: process_creation
  product: windows
tactics:
- Execution
relevantTechniques:
- T1059
query: 'DeviceProcessEvents

  | where ProcessCommandLine contains "Add-ADDBSidHistory" or ProcessCommandLine contains
  "Add-ADNgcKey" or ProcessCommandLine contains "Add-ADReplNgcKey" or ProcessCommandLine
  contains "ConvertFrom-ADManagedPasswordBlob" or ProcessCommandLine contains "ConvertFrom-GPPrefPassword"
  or ProcessCommandLine contains "ConvertFrom-ManagedPasswordBlob" or ProcessCommandLine
  contains "ConvertFrom-UnattendXmlPassword" or ProcessCommandLine contains "ConvertFrom-UnicodePassword"
  or ProcessCommandLine contains "ConvertTo-AADHash" or ProcessCommandLine contains
  "ConvertTo-GPPrefPassword" or ProcessCommandLine contains "ConvertTo-KerberosKey"
  or ProcessCommandLine contains "ConvertTo-LMHash" or ProcessCommandLine contains
  "ConvertTo-MsoPasswordHash" or ProcessCommandLine contains "ConvertTo-NTHash" or
  ProcessCommandLine contains "ConvertTo-OrgIdHash" or ProcessCommandLine contains
  "ConvertTo-UnicodePassword" or ProcessCommandLine contains "Disable-ADDBAccount"
  or ProcessCommandLine contains "Enable-ADDBAccount" or ProcessCommandLine contains
  "Get-ADDBAccount" or ProcessCommandLine contains "Get-ADDBBackupKey" or ProcessCommandLine
  contains "Get-ADDBDomainController" or ProcessCommandLine contains "Get-ADDBGroupManagedServiceAccount"
  or ProcessCommandLine contains "Get-ADDBKdsRootKey" or ProcessCommandLine contains
  "Get-ADDBSchemaAttribute" or ProcessCommandLine contains "Get-ADDBServiceAccount"
  or ProcessCommandLine contains "Get-ADDefaultPasswordPolicy" or ProcessCommandLine
  contains "Get-ADKeyCredential" or ProcessCommandLine contains "Get-ADPasswordPolicy"
  or ProcessCommandLine contains "Get-ADReplAccount" or ProcessCommandLine contains
  "Get-ADReplBackupKey" or ProcessCommandLine contains "Get-ADReplicationAccount"
  or ProcessCommandLine contains "Get-ADSIAccount" or ProcessCommandLine contains
  "Get-AzureADUserEx" or ProcessCommandLine contains "Get-BootKey" or ProcessCommandLine
  contains "Get-KeyCredential" or ProcessCommandLine contains "Get-LsaBackupKey" or
  ProcessCommandLine contains "Get-LsaPolicy" or ProcessCommandLine contains "Get-SamPasswordPolicy"
  or ProcessCommandLine contains "Get-SysKey" or ProcessCommandLine contains "Get-SystemKey"
  or ProcessCommandLine contains "New-ADDBRestoreFromMediaScript" or ProcessCommandLine
  contains "New-ADKeyCredential" or ProcessCommandLine contains "New-ADNgcKey" or
  ProcessCommandLine contains "New-NTHashSet" or ProcessCommandLine contains "Remove-ADDBObject"
  or ProcessCommandLine contains "Save-DPAPIBlob" or ProcessCommandLine contains "Set-ADAccountPasswordHash"
  or ProcessCommandLine contains "Set-ADDBAccountPassword" or ProcessCommandLine contains
  "Set-ADDBBootKey" or ProcessCommandLine contains "Set-ADDBDomainController" or ProcessCommandLine
  contains "Set-ADDBPrimaryGroup" or ProcessCommandLine contains "Set-ADDBSysKey"
  or ProcessCommandLine contains "Set-AzureADUserEx" or ProcessCommandLine contains
  "Set-LsaPolicy" or ProcessCommandLine contains "Set-SamAccountPasswordHash" or ProcessCommandLine
  contains "Set-WinUserPasswordHash" or ProcessCommandLine contains "Test-ADDBPasswordQuality"
  or ProcessCommandLine contains "Test-ADPasswordQuality" or ProcessCommandLine contains
  "Test-ADReplPasswordQuality" or ProcessCommandLine contains "Test-PasswordQuality"
  or ProcessCommandLine contains "Unlock-ADDBAccount" or ProcessCommandLine contains
  "Write-ADNgcKey" or ProcessCommandLine contains "Write-ADReplNgcKey"'
eventGroupingSettings:
  aggregationKind: SingleAlert
queryFrequency: P1D
queryPeriod: P1D
enabled: true
entityMappings: null
sentinelEntitiesMappings: null
triggerThreshold: 0
suppressionDuration: PT5H
suppressionEnabled: false
triggerOperator: GreaterThan
kind: Scheduled
