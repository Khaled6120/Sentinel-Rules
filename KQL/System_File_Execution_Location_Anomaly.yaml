name: System File Execution Location Anomaly
id: e4a6b256-3e47-40fc-89d2-7a477edd6915
author: Florian Roth (Nextron Systems), Patrick Bareiss, Anton Kutepov, oscd.community,
  Nasreddine Bencherchali (Nextron Systems)
date: 2017-11-27
severity: high
description: 'Detects the execution of a Windows system binary that is usually located
  in the system folder from an uncommon location.

  '
status: experimental
modified: 2024-07-16
logsource:
  category: process_creation
  product: windows
tactics:
- Defense-evasion
relevantTechniques:
- T1036
query: 'DeviceProcessEvents

  | where (FolderPath endswith "\\atbroker.exe" or FolderPath endswith "\\audiodg.exe"
  or FolderPath endswith "\\bcdedit.exe" or FolderPath endswith "\\bitsadmin.exe"
  or FolderPath endswith "\\certreq.exe" or FolderPath endswith "\\certutil.exe" or
  FolderPath endswith "\\cmstp.exe" or FolderPath endswith "\\conhost.exe" or FolderPath
  endswith "\\consent.exe" or FolderPath endswith "\\cscript.exe" or FolderPath endswith
  "\\csrss.exe" or FolderPath endswith "\\dashost.exe" or FolderPath endswith "\\defrag.exe"
  or FolderPath endswith "\\dfrgui.exe" or FolderPath endswith "\\dism.exe" or FolderPath
  endswith "\\dllhost.exe" or FolderPath endswith "\\dllhst3g.exe" or FolderPath endswith
  "\\dwm.exe" or FolderPath endswith "\\eventvwr.exe" or FolderPath endswith "\\logonui.exe"
  or FolderPath endswith "\\LsaIso.exe" or FolderPath endswith "\\lsass.exe" or FolderPath
  endswith "\\lsm.exe" or FolderPath endswith "\\msiexec.exe" or FolderPath endswith
  "\\ntoskrnl.exe" or FolderPath endswith "\\powershell_ise.exe" or FolderPath endswith
  "\\powershell.exe" or FolderPath endswith "\\pwsh.exe" or FolderPath endswith "\\regsvr32.exe"
  or FolderPath endswith "\\rundll32.exe" or FolderPath endswith "\\runonce.exe" or
  FolderPath endswith "\\RuntimeBroker.exe" or FolderPath endswith "\\schtasks.exe"
  or FolderPath endswith "\\services.exe" or FolderPath endswith "\\sihost.exe" or
  FolderPath endswith "\\smartscreen.exe" or FolderPath endswith "\\smss.exe" or FolderPath
  endswith "\\spoolsv.exe" or FolderPath endswith "\\svchost.exe" or FolderPath endswith
  "\\taskhost.exe" or FolderPath endswith "\\Taskmgr.exe" or FolderPath endswith "\\userinit.exe"
  or FolderPath endswith "\\wininit.exe" or FolderPath endswith "\\winlogon.exe" or
  FolderPath endswith "\\winver.exe" or FolderPath endswith "\\wlanext.exe" or FolderPath
  endswith "\\wscript.exe" or FolderPath endswith "\\wsl.exe" or FolderPath endswith
  "\\wsmprovhost.exe") and (not(((FolderPath startswith "C:\\$WINDOWS.~BT\\" or FolderPath
  startswith "C:\\$WinREAgent\\" or FolderPath startswith "C:\\Windows\\SoftwareDistribution\\"
  or FolderPath startswith "C:\\Windows\\System32\\" or FolderPath startswith "C:\\Windows\\SystemTemp\\"
  or FolderPath startswith "C:\\Windows\\SysWOW64\\" or FolderPath startswith "C:\\Windows\\uus\\"
  or FolderPath startswith "C:\\Windows\\WinSxS\\") or (FolderPath in~ ("C:\\Program
  Files\\PowerShell\\7\\pwsh.exe", "C:\\Program Files\\PowerShell\\7-preview\\pwsh.exe"))
  or (FolderPath endswith "\\wsl.exe" and FolderPath startswith "C:\\Program Files\\WindowsApps\\MicrosoftCorporationII.WindowsSubsystemForLinux"))))
  and (not(FolderPath contains "\\SystemRoot\\System32\\"))'
eventGroupingSettings:
  aggregationKind: SingleAlert
queryFrequency: P1D
queryPeriod: P1D
enabled: true
entityMappings: null
sentinelEntitiesMappings: null
triggerThreshold: 0
suppressionDuration: PT5H
suppressionEnabled: false
triggerOperator: GreaterThan
kind: Scheduled
