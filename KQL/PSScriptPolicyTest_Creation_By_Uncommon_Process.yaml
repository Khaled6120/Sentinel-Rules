name: PSScriptPolicyTest Creation By Uncommon Process
id: 1027d292-dd87-4a1a-8701-2abe04d7783c
author: Nasreddine Bencherchali (Nextron Systems)
date: 2023-06-01
severity: medium
description: Detects the creation of the "PSScriptPolicyTest" PowerShell script by
  an uncommon process. This file is usually generated by Microsoft Powershell to test
  against Applocker.
status: experimental
modified: 2023-12-11
logsource:
  category: file_event
  product: windows
tactics:
- Defense-evasion
relevantTechniques: []
query: 'DeviceFileEvents

  | where FolderPath contains "__PSScriptPolicyTest_" and (not((InitiatingProcessFolderPath
  endswith ":\\Program Files\\PowerShell\\7-preview\\pwsh.exe" or InitiatingProcessFolderPath
  endswith ":\\Program Files\\PowerShell\\7\\pwsh.exe" or InitiatingProcessFolderPath
  endswith ":\\Windows\\System32\\dsac.exe" or InitiatingProcessFolderPath endswith
  ":\\Windows\\System32\\sdiagnhost.exe" or InitiatingProcessFolderPath endswith ":\\Windows\\System32\\ServerManager.exe"
  or InitiatingProcessFolderPath endswith ":\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell_ise.exe"
  or InitiatingProcessFolderPath endswith ":\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"
  or InitiatingProcessFolderPath endswith ":\\Windows\\System32\\wsmprovhost.exe"
  or InitiatingProcessFolderPath endswith ":\\Windows\\SysWOW64\\sdiagnhost.exe" or
  InitiatingProcessFolderPath endswith ":\\Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell_ise.exe"
  or InitiatingProcessFolderPath endswith ":\\Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell.exe")))'
eventGroupingSettings:
  aggregationKind: SingleAlert
queryFrequency: P1D
queryPeriod: P1D
enabled: true
entityMappings: null
sentinelEntitiesMappings: null
triggerThreshold: 0
suppressionDuration: PT5H
suppressionEnabled: false
triggerOperator: GreaterThan
kind: Scheduled
