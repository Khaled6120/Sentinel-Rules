{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2020-08-01",
      "name": "[concat(parameters('workspace'), '/Potentially_Suspicious_File_Download_From_File_Sharing_Domain_Via_PowerShell.EXE')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "eTag": "*",
        "displayName": "Potentially Suspicious File Download From File Sharing Domain Via PowerShell.EXE",
        "category": "Hunting Queries",
        "query": "DeviceProcessEvents\n| where (ProcessCommandLine contains \".DownloadString(\" or ProcessCommandLine contains \".DownloadFile(\" or ProcessCommandLine contains \"Invoke-WebRequest \" or ProcessCommandLine contains \"iwr \" or ProcessCommandLine contains \"wget \") and ((FolderPath endswith \"\\\\powershell.exe\" or FolderPath endswith \"\\\\pwsh.exe\") or (ProcessVersionInfoOriginalFileName in~ (\"PowerShell.EXE\", \"pwsh.dll\"))) and (ProcessCommandLine contains \"anonfiles.com\" or ProcessCommandLine contains \"cdn.discordapp.com\" or ProcessCommandLine contains \"cdn.discordapp.com/attachments/\" or ProcessCommandLine contains \"ddns.net\" or ProcessCommandLine contains \"dl.dropboxusercontent.com\" or ProcessCommandLine contains \"ghostbin.co\" or ProcessCommandLine contains \"glitch.me\" or ProcessCommandLine contains \"gofile.io\" or ProcessCommandLine contains \"hastebin.com\" or ProcessCommandLine contains \"mediafire.com\" or ProcessCommandLine contains \"mega.nz\" or ProcessCommandLine contains \"onrender.com\" or ProcessCommandLine contains \"paste.ee\" or ProcessCommandLine contains \"pastebin.com\" or ProcessCommandLine contains \"pastebin.pl\" or ProcessCommandLine contains \"pastetext.net\" or ProcessCommandLine contains \"privatlab.com\" or ProcessCommandLine contains \"privatlab.net\" or ProcessCommandLine contains \"send.exploit.in\" or ProcessCommandLine contains \"sendspace.com\" or ProcessCommandLine contains \"storage.googleapis.com\" or ProcessCommandLine contains \"storjshare.io\" or ProcessCommandLine contains \"supabase.co\" or ProcessCommandLine contains \"temp.sh\" or ProcessCommandLine contains \"transfer.sh\" or ProcessCommandLine contains \"ufile.io\")",
        "version": 1,
        "tags": [
          {
            "name": "description",
            "value": "etects potentially suspicious file downloads from file sharing domains using PowerShell.e"
          },
          {
            "name": "tactics",
            "value": "execution"
          }
        ]
      }
    }
  ]
}
