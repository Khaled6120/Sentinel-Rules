{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2020-08-01",
      "name": "[concat(parameters('workspace'), '/PUA_-_PingCastle_Execution_From_Potentially_Suspicious_Parent')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "eTag": "*",
        "displayName": "PUA - PingCastle Execution From Potentially Suspicious Parent",
        "category": "Hunting Queries",
        "query": "DeviceProcessEvents\n| where ((InitiatingProcessCommandLine contains \".bat\" or InitiatingProcessCommandLine contains \".chm\" or InitiatingProcessCommandLine contains \".cmd\" or InitiatingProcessCommandLine contains \".hta\" or InitiatingProcessCommandLine contains \".htm\" or InitiatingProcessCommandLine contains \".html\" or InitiatingProcessCommandLine contains \".js\" or InitiatingProcessCommandLine contains \".lnk\" or InitiatingProcessCommandLine contains \".ps1\" or InitiatingProcessCommandLine contains \".vbe\" or InitiatingProcessCommandLine contains \".vbs\" or InitiatingProcessCommandLine contains \".wsf\") or (InitiatingProcessCommandLine contains \":\\\\Perflogs\\\\\" or InitiatingProcessCommandLine contains \":\\\\Temp\\\\\" or InitiatingProcessCommandLine contains \":\\\\Users\\\\Public\\\\\" or InitiatingProcessCommandLine contains \":\\\\Windows\\\\Temp\\\\\" or InitiatingProcessCommandLine contains \"\\\\AppData\\\\Local\\\\Temp\" or InitiatingProcessCommandLine contains \"\\\\AppData\\\\Roaming\\\\\" or InitiatingProcessCommandLine contains \"\\\\Temporary Internet\") or ((InitiatingProcessCommandLine contains \":\\\\Users\\\\\" and InitiatingProcessCommandLine contains \"\\\\Favorites\\\\\") or (InitiatingProcessCommandLine contains \":\\\\Users\\\\\" and InitiatingProcessCommandLine contains \"\\\\Favourites\\\\\") or (InitiatingProcessCommandLine contains \":\\\\Users\\\\\" and InitiatingProcessCommandLine contains \"\\\\Contacts\\\\\"))) and (InitiatingProcessCommandLine contains \".bat\" or InitiatingProcessCommandLine contains \".chm\" or InitiatingProcessCommandLine contains \".cmd\" or InitiatingProcessCommandLine contains \".hta\" or InitiatingProcessCommandLine contains \".htm\" or InitiatingProcessCommandLine contains \".html\" or InitiatingProcessCommandLine contains \".js\" or InitiatingProcessCommandLine contains \".lnk\" or InitiatingProcessCommandLine contains \".ps1\" or InitiatingProcessCommandLine contains \".vbe\" or InitiatingProcessCommandLine contains \".vbs\" or InitiatingProcessCommandLine contains \".wsf\") and (FolderPath endswith \"\\\\PingCastle.exe\" or ProcessVersionInfoOriginalFileName =~ \"PingCastle.exe\" or ProcessVersionInfoProductName =~ \"Ping Castle\" or (ProcessCommandLine contains \"--scanner aclcheck\" or ProcessCommandLine contains \"--scanner antivirus\" or ProcessCommandLine contains \"--scanner computerversion\" or ProcessCommandLine contains \"--scanner foreignusers\" or ProcessCommandLine contains \"--scanner laps_bitlocker\" or ProcessCommandLine contains \"--scanner localadmin\" or ProcessCommandLine contains \"--scanner nullsession\" or ProcessCommandLine contains \"--scanner nullsession-trust\" or ProcessCommandLine contains \"--scanner oxidbindings\" or ProcessCommandLine contains \"--scanner remote\" or ProcessCommandLine contains \"--scanner share\" or ProcessCommandLine contains \"--scanner smb\" or ProcessCommandLine contains \"--scanner smb3querynetwork\" or ProcessCommandLine contains \"--scanner spooler\" or ProcessCommandLine contains \"--scanner startup\" or ProcessCommandLine contains \"--scanner zerologon\") or ProcessCommandLine contains \"--no-enum-limit\" or (ProcessCommandLine contains \"--healthcheck\" and ProcessCommandLine contains \"--level Full\") or (ProcessCommandLine contains \"--healthcheck\" and ProcessCommandLine contains \"--server \"))",
        "version": 1,
        "tags": [
          {
            "name": "description",
            "value": "Detects the execution of PingCastle, a tool designed to quickly assess the Active Directory security level via a script located in a potentially suspicious or uncommon location.\n"
          },
          {
            "name": "tactics",
            "value": "Reconnaissance"
          },
          {
            "name": "relevantTechniques",
            "value": "T1595"
          }
        ]
      }
    }
  ]
}
